data "aws_ami" "ubuntu" {
    most_recent = true
#  owners = ["099720109477"]

    filter {
        name   = "name"
        values = ["ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*"]
  }
    owners = ["099720109477"]
}


resource "aws_instance" "test" {
    ami           = "${data.aws_ami.ubuntu.id}"
#   ami           = data.aws_ami.ubuntu-server.id
   instance_type = "t2.micro"
   #security_groups = [ "${aws_security_group.first.id}" ]
   key_name = "ubuntu3"
   tags = {
    Name = "my_ubuntu"
  }
}

resource "aws_security_group" "allow_ssh" {
  name        = "allow_ssh"
  description = "Allow SSH inbound traffic"
  vpc_id      = "vpc-b37a8ad5"

  ingress {
    description = "SSH from VPC"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  #egress {
   # from_port   = 0
    #to_port     = 0
    #protocol    = "ssh"
    #cidr_blocks = ["0.0.0.0/0"]
  #}

  tags = {
    Name = "allow_ssh"
  }
}

resource "aws_network_interface_sg_attachment" "sg_attachment" {
  security_group_id    = "${aws_security_group.allow_ssh.id}"
  network_interface_id = "eni-04fd84054e4914566"
}

#module "vote_service_sg" {
 # source = "terraform-aws-modules/security-group/aws"
  #name        = "user-service"
  #description = "Security group for user-service with custom ports open within VPC, and PostgreSQL publicly open"
  #vpc_id      = "vpc-df4535a7"
  #ingress_cidr_blocks      = ["0.0.0.0/0"]
  #ingress_rules            = ["ssh-tcp"]
#}



module "key_pair" {
  source = "terraform-aws-modules/key-pair/aws"
  key_name   = "ubuntu3"
  public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyYZGvc3W4dxCRH+oTru7luhaMYRjl7p3woZ5L2YHq/TexBveNC0ePlJay826PEGnorHmlndziQ+GZuC2lYxQm1/McCwlo42sEtYWE6sZUMBEbFdMdAJq3OPdphxxZSK6/pcAQXEI3Lw5IEBcT4pvTqNK/oLOZDN+0qbgymWOZAHRTEblPzJPfA4d/Zt3M0GyM9m8Q0avf2CvhtIjQzND0gn3BuevsKSytr5B9PkvMxGr8PUsxRrd74ox1dG0uiXbXHz7Mc9aJTArM8AfepQOqAA0SyLWQZCeGIsiLo8FkV0QPQwp3QRErae6F0VKVF56fup3FxmKDZRs1FF1FmJhL ububtu3"
  #key_name   = "ubuntu4"
  #public_key = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKc/LLhu+3MHMBGgRtrEQGgDyjyr77doE5zEB3h1LUcs ed25519-key-20200702"
}
